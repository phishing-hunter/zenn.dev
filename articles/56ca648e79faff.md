---
title: "Phishing Hunging Operations (PHOps) の自動化"
emoji: "🦔"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: 
 - docker
 - github
published: false
---

## はじめに
日常的なインシデント調査を効率化するために、自動化による分析は、フィッシング詐欺の分析者にとって重要な課題となっています。
クラウドベースの技術は、効率的にフィッシング詐欺の分析を自動化するための良い解決策です。
今回は、クラウドサービス上でのフィッシング詐欺分析の自動化方法について解説していきます。

## 構築したシステム
このシステムは、AWS上で動作しており、Certstreamから収集した証明書の更新履歴を収集しています。収集している履歴は定義されたルールに基づいてスコアリングされ[Googleドライブ](https://drive.google.com/drive/folders/1cUyCmCEl865rnZXjIywa0P9OcwwNm5Ac?usp=sharing)へと保存して公開しています。
スコアが閾値を超えたドメインについては[urlscan](https://urlscan.io)を使ってHTMLを取得してYaraルールでコンテンツチェックを実施して、フィッシングサイトと判定された場合にGoogleセーフブラウジングとTwitterに詳細を投稿しています。
スコアリングルールやYaraルールについても[Github](https://github.com/phishing-hunter/PHOps)に公開してるので、プルリクエスト経由で誰でも修正することが可能です。

![](https://camo.githubusercontent.com/90b465a3d749fb61b0997cc46a80053e867b587e9006bd98ee3ffcecd69b67c7/68747470733a2f2f692e696d6775722e636f6d2f327a774436316c2e706e67)

## ルールの検証について
過剰な検出を避けるためにGithub Actionを使ってスコアリングルールを最新の履歴を使って常に検証することができます。  
Github Actionが失敗した場合はプルリクエストが行えないようになっています。

例えば以下のようにgithubにPushする前にスコアリングルールが問題ないかどうか検証することができます。スコアが150のドメインは1日500件までしか検出しないように調整しています。  
```bash
docker run --rm -it \
    -v $PWD:/work \
	-w /work \
	phishinghunter/config-checker:20230125 \
	/app/checker.py suspicious.yaml -f /csv/target.csv -m 500 -s 150
```

## スコアリングアルゴリズムについて
スコアリングアルゴリズムは[こちら](https://github.com/phishing-hunter/config-checker)のリポジトリに公開しています。
[phishing_catcher](https://github.com/x0rz/phishing_catcher)を参考に実装しており、ルールと同じように誰でも修正をリクエストすることができます。

また、以下のように2023/01/25の履歴の中で`mydns.jp`を含むドメイン名のスコアを確認することができます。
```bash
docker run --rm -it -v $PWD:/work -w /work \
    phishinghunter/config-checker:20230125 \
    bash -c 'cat /csv/target.csv|grep mydns.jp|python /app/checker.py suspicious.yaml -s 0'
```

## 最後に
今回はGithubを中心としたフィッシング詐欺検出の自動化方法について解説しましたが、Googleドライブに公開されるログは4時間ごとに最新のログをアップロードしているだけなのでリアルタイムにフィッシング詐欺を検出することはできません。
もしリアルタイムに検出したフィッシングサイトの通知が必要な場合は[こちら](http://phishing-hunter.com/login)に登録してみてください。通知はslackだけでなくwebhookでも通知することが可能です。

この記事を読んで、少しでもお役に立てたなら幸いです。何か質問やご意見がありましたら、お気軽にご連絡ください。  

## 参考
* [Malware Analysis Operations（MAOps）の自動化](https://blogs.jpcert.or.jp/ja/2023/01/cloud_malware_analysis.html)
