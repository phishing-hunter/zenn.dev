---
title: "ã€ŒFakeshellã€ã§æ¨™çš„å‹æ”»æ’ƒã®æ¼”ç¿’ç’°å¢ƒã‚’ä½œã‚‹"
emoji: "ğŸ¬"
type: "tech"
topics:
  - "docker"
  - "linux"
  - "python"
  - "security"
published: true
published_at: "2022-12-29 19:02"
---

æ¨™çš„å‹æ”»æ’ƒï¼ˆAPT: Advanced Persistent Threatï¼‰ã¨ã¯ã€ç‰¹å®šã®ç›®çš„ã‚’é”æˆã™ã‚‹ãŸã‚ã«ç‰¹å®šã®çµ„ç¹”ã‚„å€‹äººã‚’æ¨™çš„ã¨ã™ã‚‹ã€é•·æœŸçš„ã§æŒç¶šçš„ãªæ”»æ’ƒã®ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚ã“ã®æ”»æ’ƒã®ç‰¹å¾´ã¯ã€æ¨™çš„ã¨ãªã‚‹çµ„ç¹”ã‚„å€‹äººã‚’æ”»æ’ƒã™ã‚‹ãŸã‚ã«ã€æ§˜ã€…ãªæ‰‹æ®µã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã™ã€‚ä¾‹ãˆã°ã€è„†å¼±æ€§ã‚’çªã„ãŸã‚Šã€ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°æ”»æ’ƒã‚’è¡Œã£ãŸã‚Šã€ãƒãƒ«ã‚¦ã‚§ã‚¢ã‚’åŸ‹ã‚è¾¼ã‚“ã ã‚Šã€ç›—è´ã™ã‚‹ã“ã¨ãªã©ã§ã™ã€‚

ã“ã®ã‚ˆã†ãªæ”»æ’ƒã¯ã€ä¼æ¥­ã‚„æ”¿åºœæ©Ÿé–¢ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹ã€æ§˜ã€…ãªçµ„ç¹”ãŒæ¨™çš„ã¨ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€é˜²å¾¡ã®ãŸã‚ã«ã¯ã€å¸¸ã«æœ€æ–°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’è¡Œã„ã€ç¤¾å†…ã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ„è­˜ã®å‘ä¸Šã®ãŸã‚ã®ç¶™ç¶šçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ã™ã‚‹ä¸Šã§ã€æœ¬ç‰©ã®ãƒãƒƒã‚«ãƒ¼ãŒä½¿ã†ã‚ˆã†ãªæ”»æ’ƒãƒ„ãƒ¼ãƒ«ã‚„è„†å¼±æ€§ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã¯é›£ã—ãå®Ÿè£…ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€å®Ÿéš›ã«ã¯æ”»æ’ƒã‚’è¡Œã‚ãšã«ç”»é¢ã®è¡¨ç¤ºã‚„ç—•è·¡ã®ä½œæˆã‚’æ¼”å‡ºã™ã‚‹ã ã‘ãªã‚‰ç°¡å˜ã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚’ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã€ŒFakeshellã€ã‚’å…¬é–‹ã—ã¾ã—ãŸã€‚

@[tweet](https://twitter.com/hunter_phishing/status/1608057718279122947)


ä¾‹ãˆã°ã€æ”»æ’ƒè€…ãŒã‚ˆãä½¿ã†ã¨æ€ã‚ã‚Œã‚‹nmapã®ã‚ˆã†ãªãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒŠã‚„ExploitKitã«ã¤ã„ã¦ã‚‚ã€fakeshellã«å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€æ”»æ’ƒå´ã®ã‚·ãƒŠãƒªã‚ªã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ä½¿ã„æ–¹
å®Ÿéš›ã«fakeshellã‚’ä½¿ã†ã«ã¯ã€ã¾ãšä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```bash
$ pip install fakeshell
```

æ¬¡ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
```python
from fakeshell.shell import FakeShell
fake_sh = FakeShell(cwd="/tmp")
```

FakeShellã‚¯ãƒ©ã‚¹ã®run_commandãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€æŒ‡å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```python
for result in fake_sh.run_command("echo hoge > hoge.txt ; cat hoge.txt | md5sum"):
    print(result)
```
å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚
```bash
c59548c3c576228486a1f0037eb16a1b  -
```

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã¯ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦SSHã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¦æ¥ç¶šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

```bash
git clone https://github.com/phishing-hunter/fakeshell
cd fakeshell/example
ssh-keygen -t rsa -b 4096 -m PEM -f /tmp/server.key
python fake_ssh_server.py &
ssh root@localhost -p 2222 # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯(password)
```

ã¾ãŸä»¥ä¸‹ã®ã‚ˆã†ã«ç‹¬è‡ªã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
from fakeshell.interpreter import register_command

def hello(args="", stdin=""):
    stdout = f"Hello, {args}"
    return stdout

register_command("hello", hello)
```
ç™»éŒ²ã—ãŸã‚³ãƒãƒ³ãƒ‰ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦å®Ÿè¡Œã§ãã¾ã™ã€‚
```python
for result in fake_sh.run_command("hello John"):
    print(result)
```

## æ¼”ç¿’ã‚·ãƒŠãƒªã‚ªã®æµã‚Œ
ä¸‹è¨˜ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã€fakeshellã‚’ä½¿ã£ã¦æ¨™çš„å‹æ”»æ’ƒã®ã‚·ãƒŠãƒªã‚ªã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚æ”»æ’ƒå´ã®ã‚·ãƒŠãƒªã‚ªã‹ã‚‰èª¬æ˜ã—ã¾ã™ã€‚
```bash
# ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã™ã‚‹
fakeshell> nmap -sV [æ”»æ’ƒå¯¾è±¡ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹]

# è„†å¼±æ€§ã‚’ç™ºè¦‹ã—ãŸã‚‰ã€exploitã‚’ä½¿ç”¨ã—ã¦æ”»æ’ƒã‚’é–‹å§‹ã™ã‚‹
fakeshell> exploit [è„†å¼±æ€§ç•ªå·]
```

é˜²å¾¡å´ã®ã‚·ãƒŠãƒªã‚ªã§ã¯ã€ã¾ãšã‚·ã‚¹ãƒ†ãƒ ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```bash
fakeshell> netstat -tan
fakeshell> ps aux
fakeshell> last
```

æ”»æ’ƒè€…ãŒä½¿ç”¨ã—ãŸæ”»æ’ƒãƒ„ãƒ¼ãƒ«ã‚„è„†å¼±æ€§ã‚’çªã„ãŸå…·ä½“çš„ãªã‚³ãƒãƒ³ãƒ‰ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€æ”»æ’ƒã®è¿½è·¡ã‚„å¯¾ç­–ã®æ¤œè¨ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
fakeshell> cat /var/log/auth.log
fakeshell> grep -r "exploit" /var/log/auth.log
fakeshell> ls -l /tmp
```

ã¾ãŸã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
fakeshell> iptables -L
fakeshell> iptables -A INPUT -p tcp --dport 80 -j DROP
```

## æ¼”ç¿’ã‚·ãƒŠãƒªã‚ªã®å®Ÿè£…
ä»¥ä¸‹ã¯ã€nmapã‚³ãƒãƒ³ãƒ‰ã‚’fakeshellã«è¿½åŠ ã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚
```python
import shlex

def cmd_nmap(cmd_args="", std_in=""):
    cmd_args = shlex.split(cmd_args)
    if "--help" in cmd_args or "-h" in cmd_args:
        return """
nmap - Network exploration tool and security/port scanner
Synopsis:
  nmap [OPTION]... [TARGET]...
Description:
  Scan the TARGET hosts to determine the service and version information.
Options:
  -sV              probe open ports to determine service/version info
  -p [portlist]    specify port range to scan
  --top-ports num  scan the top num most common ports
  -oA [file]       output scan results in the specified file in three formats
  --help           display this help and exit
"""
    std_out = "ãƒ€ãƒŸãƒ¼ã®çµæœå‡ºåŠ›"
    return std_out

register_command("nmap", cmd_nmap)
```

æ¬¡ã¯æ”»æ’ƒãƒ„ãƒ¼ãƒ«ã‚’ç°¡å˜ã«å®Ÿè£…ã™ã‚‹ãŸã‚ã®ä¾‹ã§ã™ã€‚
æ”»æ’ƒã«æˆåŠŸã—ãŸã¨ãã®æŒ™å‹•ã‚„ã€æ”»æ’ƒã«å¤±æ•—ã—ãŸã¨ãã®æŒ™å‹•ã‚’ãã‚Œãã‚Œå®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã«ã€cmd_exploité–¢æ•°ã®ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚
```python
import shlex
import random

def cmd_exploit(cmd_args="", std_in=""):
    cmd_args = shlex.split(cmd_args)
    if "--help" in cmd_args or "-h" in cmd_args:
        return """
exploit - execute an exploit
Synopsis:
  exploit [OPTION]... [EXPLOIT_NAME]
Description:
  Execute the specified exploit.
Options:
  --help                display this help and exit
"""

    if len(cmd_args) < 1:
        return "Error: specify exploit name"

    exploit_name = cmd_args[0]

    # ãƒ€ãƒŸãƒ¼ã®ãƒ­ã‚°è¿½è¨˜
    with open("/var/log/syslog", "a") as f:
        f.write("Executed exploit: {}\n".format(exploit_name))

    # æ”»æ’ƒãŒæˆåŠŸã™ã‚‹ç¢ºç‡ã¯50%
    if random.randint(0, 1) == 0:
        # ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’è¨­ç½®ã™ã‚‹
        with open("/tmp/backdoor.sh", "w") as f:
            f.write("#!/bin/bash\n")
            f.write("echo 'I am a backdoor'\n")
        return "Exploit success"
    return "Exploit failed"
    
register_command("exploit", cmd_exploit)
```

## ã¾ã¨ã‚
fakeshellã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¼”ç¿’ã ã‘ã§ãªããƒãƒ‹ãƒ¼ãƒãƒƒãƒˆæ§‹ç¯‰ã€ãƒãƒ«ã‚¦ã‚§ã‚¢è§£æç”¨ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãªã©ã€æ§˜ã€…ãªç”¨é€”ã§æ´»ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»Šå¾Œã‚‚ã€å®Ÿéš›ã®Linuxã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ã‚ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚„ã€æ”»æ’ƒè€…ãŒã‚ˆãä½¿ã†ã¨æ€ã‚ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’ã€fakeshellã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã‚ˆã†ã€é–‹ç™ºã‚’ç¶šã‘ã¦ã„ãäºˆå®šã§ã™ã€‚
ã“ã®è¨˜äº‹ã‚’èª­ã‚“ã§ã€å°‘ã—ã§ã‚‚ãŠå½¹ã«ç«‹ã¦ãŸãªã‚‰å¹¸ã„ã§ã™ã€‚ä½•ã‹è³ªå•ã‚„ã”æ„è¦‹ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚
